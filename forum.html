<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Forum — Mini LMS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="common.css" />
</head>
<body>
  <div class="container">
    <div class="header card">
      <div class="logo"><div class="box">LMS</div><div><div style="font-weight:800">Forum</div><div class="small muted">Discuss</div></div></div>
      <div><a href="dashboard.html" class="btn ghost">← Dashboard</a></div>
    </div>

    <div class="card">
      <h3>Post a question</h3>
      <input id="topic" class="input" placeholder="Subject or topic" />
      <textarea id="body" class="input" rows="4" style="margin-top:8px"></textarea>
      <div style="margin-top:8px"><button id="postBtn" class="btn">Post</button></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Threads</h3>
      <div id="threads"></div>
    </div>
  </div>

<script>
const DB = {
  get(k,d=null){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch(e){ return d }},
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)) }, push(k,v){ const a=DB.get(k,[]); a.push(v); DB.set(k,a) }
};
if (!DB.get('threads')) DB.set('threads',[]);
const me = DB.get('currentUser'); if(!me){ alert('Not signed'); location.href='index.html' }
document.getElementById('postBtn').addEventListener('click', ()=>{
  const topic = document.getElementById('topic').value.trim();
  const body = document.getElementById('body').value.trim();
  if (!topic || !body) return alert('topic & body required');
  DB.push('threads', { id: Date.now(), topic, body, author: me.email, at: Date.now(), replies: []});
  render();
});
function render(){
  const threads = DB.get('threads',[]).slice().reverse();
  const area = document.getElementById('threads'); area.innerHTML='';
  if (!threads.length) { area.innerHTML = '<div class="small muted">No threads</div>'; return; }
  threads.forEach(t=>{
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${t.topic}</strong><div class="small muted">${t.author} • ${new Date(t.at).toLocaleString()}</div></div><div><button class="btn" data-id="${t.id}">Reply</button></div></div><div style="margin-top:8px">${t.body}</div><div class="small muted" id="replies-${t.id}" style="margin-top:8px"></div>`;
    area.appendChild(div);
    div.querySelector('button')?.addEventListener('click', ()=> {
      const reply = prompt('Reply:');
      if (!reply) return;
      const threads = DB.get('threads',[]);
      const idx = threads.findIndex(x=>x.id===t.id);
      threads[idx].replies.push({author:me.email, body:reply, at:Date.now()});
      DB.set('threads', threads); render();
    });
    const rdiv = div.querySelector(`#replies-${t.id}`);
    if (t.replies && t.replies.length) {
      rdiv.innerHTML = t.replies.map(r=>`<div style="padding:6px;border-top:1px solid rgba(255,255,255,0.03)"><strong>${r.author}</strong>: ${r.body} <div class="small muted">${new Date(r.at).toLocaleString()}</div></div>`).join('');
    } else rdiv.innerHTML = '<div class="small muted">No replies</div>';
  });
}
render();
</script>
</body>
</html>
